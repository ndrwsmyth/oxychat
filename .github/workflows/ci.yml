name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ===========================================
  # LINTING & TYPE CHECKING
  # ===========================================
  python-lint:
    name: Python checks (backend)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: backend
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        run: |
          python -m pip install --upgrade pip
          python -m pip install ".[dev]"
          python -m pip install mypy

      - name: Syntax check
        working-directory: backend
        run: python -m compileall app

      - name: Ruff lint
        working-directory: backend
        run: python -m ruff check app

      - name: Ruff format check
        working-directory: backend
        run: |
          python -m ruff format --check app || {
            echo "::error ::Ruff format check failed. Run 'python -m ruff format app' locally to apply formatting.";
            exit 1;
          }

      - name: mypy
        working-directory: backend
        run: python -m mypy app --ignore-missing-imports

  node-build:
    name: Frontend build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Configure git auth for private dependencies
        run: |
          git config --global url."https://x-access-token:${SEDIMENT_GIT_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          SEDIMENT_GIT_TOKEN: ${{ secrets.SEDIMENT_GIT_TOKEN }}

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Type check
        working-directory: frontend
        run: pnpm exec tsc --noEmit

      - name: Lint
        working-directory: frontend
        run: pnpm run lint

      - name: Build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: https://placeholder-for-build.railway.app
        run: pnpm run build

  # ===========================================
  # PREVIEW DEPLOYMENTS (Pull Requests)
  # ===========================================
  deploy-backend-preview:
    name: Deploy Backend Preview
    runs-on: ubuntu-latest
    needs: [python-lint]
    if: github.event_name == 'pull_request'
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway (Preview)
        id: deploy
        working-directory: backend
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          DEPLOY_URL=$(railway up --detach --environment pr-${{ github.event.number }} 2>&1 | grep -oP 'https://[^\s]+' | head -1)
          echo "url=${DEPLOY_URL}" >> $GITHUB_OUTPUT
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-frontend-preview:
    name: Deploy Frontend Preview
    runs-on: ubuntu-latest
    needs: [node-build]
    if: github.event_name == 'pull_request'
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        working-directory: frontend
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build for Preview
        working-directory: frontend
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Preview)
        id: deploy
        working-directory: frontend
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DEPLOY_URL}" >> $GITHUB_OUTPUT

      - name: Comment PR with URLs
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Preview Deployment Ready

              | Service | URL |
              |---------|-----|
              | Frontend | ${{ steps.deploy.outputs.url }} |

              _Deployed from commit ${{ github.sha }}_`
            })

  # ===========================================
  # PRODUCTION DEPLOYMENTS (main branch)
  # ===========================================
  deploy-backend-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    needs: [python-lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ vars.RAILWAY_PRODUCTION_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway (Production)
        working-directory: backend
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-frontend-production:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: [node-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ vars.VERCEL_PRODUCTION_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        working-directory: frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build for Production
        working-directory: frontend
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Production)
        working-directory: frontend
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  # ===========================================
  # DATABASE MIGRATIONS (on production deploy)
  # ===========================================
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-backend-production]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          python -m pip install .

      - name: Run Alembic migrations
        working-directory: backend
        env:
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          python -m alembic upgrade head
